### 4.3.6 Query String
query_string 파라미터를 사용하는 쿼리를 작성하면 내장된 쿼리 분석기를 이용하는 질의를 작성할 수 있다.

### 4.3.7 Prefix Query 
Prefix Query는 해당 접두어가 있는 모든 문서를 검색하는데 사용한다.

### 4.3.8 Exists Query
필드가 없거나 필드 값이 null인 문서를 제외하고, 실제 값이 존재하는 문서만 찾고 싶을때 Exists Query를 사용한다.

must_not을 이용해서 필드가 없거나 필드 값이 null인 문서만 찾을 수 있다.

### 4.3.9 Wildcard Query
검색어의 와일드카드와 일치하는 구문을 찾는다. 이때 입력된 검색어는 형태소 분석이 이루어지지 않는다.

* `*` : 문자의 길이와 상관없이 와일드카드와 일치하는 모든 문서를 찾는다.
* `?` : 지정된 위치의 한 글자가 다른 경우의 문서를 찾는다.

와일드카드를 사용할 경우 단어의 첫 글자로는 사용하지 않는다. 첫 글자로 와일드카드가 사용될 경우 색인된 전체 문서를 찾아야 하는 불상사가 발생할 수 있다.

### 4.3.10 Nested Query
Nested Query는 Nested 데이터 타입(문서 내부에 다른 문서가 존재)의 필드를 검색할 때 사용한다. path 옵션으로 중첩된 필드를 명시하고, query 옵션에 Nested 필드 검색에 사용할 쿼리를 입력한다.

엘라스틱서치는 성능상의 이유로 Parent 문서와 Child 문서를 모두 동일한 샤드에 저장한다. 이러한 방식을 통해 네트워크 비용을 대폭 줄이는 것이 가능해진다.

## 4.4 부가적인 검색 API
엘라스틱서치에서 제공되는 검색 API에는 부가적인 기능들이 다수 포함되어 있다.

### 4.4.1 효율적인 검색을 위한 환경설정

엘라스틱서치에서는 대량의 데이터 처리를 위해 기본적으로 데이터를 분산해서 처리한다. 

1. 검색 요청이 발생하면 엘라스틱서치는 모든 샤드에 검색 요청을 브로드캐스팅해서 전달하고 기다린다. 

2. 각 샤드는 자신이 가지고 있는 데이터를 기준으로 검색을 수행하고 그 결과를 리턴한다. 

3. 모든 샤드로부터 검색 결과가 도착하면 도착한 모든 결과를 조합해서 최종 질의 결과를 출력한다.

이러한 동작 방식 떄문에 제공되는 부가적인 환경설정 값이 있다. 데이터 특성이나 검색 패턴에 따라 검색 설정 값을 적절하게 수정한다면 좀 더 효율적인 클러스터 운영이 가능해진다.

#### 동적 분배 방식의 샤드 선택
엘라스틱서치는 검색을 수행할 때 동일 데이터를 가지고 있는 샤드(원본 샤드, 레플리카 샤드) 중 하나만 선택해 검색을 수행하여 결과가 중복되는 것을 방지한다.

엘라스틱서치는 검색 요청의 적절한 분배를 위해 기본적으로 라운드로빈 방식의 알고리즘(순차적으로 샤드를 선택하는 방식)을 사용한다.

엘라스틱서치는 동적 분배 방식의 알고리즘도 제공한다. 동적 분배 방식은 검색 요청의 응답시간, 검색 요청을 수행하는 스레드 풀(Thread Pool)의 크기 등을 고려해 최적의 샤드를 동적으로 결정하는 방식이다.

#### 글로벌 타임아웃 설정

검색 요청 시 타임아웃을 설정하여, 자칫 무거운 쿼리가 무한정 실행되어 전체 시스템 장애를 발생시키는 것을 막을 수 있다.

개별 검색 요청의 Request Body에 직접 타임아웃을 설정할 수 있다. 

모든 쿼리에 동일하게 적용되도록 정책으로 타임아웃을 설정 할 수 있다. 글로벌로 적용되는 타임아웃의 기본 정책은 무제한(-1)이다.

### 4.4.2 Search Shards API

Search Shards API를 이용하면 검색이 수행되는 노드 및 샤드에 대한 정보를 확인할 수 있다. 

이러한 정보는 질의를 최적화하거나 질의가 정상적으로 수행되지 않을 때 문제를 해결하는데 유용하게 활용할 수 있다.

### 4.4.3 Multi Search API

Multi Search API는 여러 건의 검색 요청을 통합해서 한번에 요청하고 한번에 결과를 종합해서 받을 떄 사용되는 API다.

Multi Search API를 사용하면 동시에 여러 개의 인덱스에서 검색을 수행할 수 있다.

### 4.4.4 Count API

Count API를 이용하면 검색된 문서의 개수만 가져올 수 있다. URI 검색과 Request Body 검색에서 모두 사용할 수 있다.

### 4.4.5 Validate API
Validate API를 사용하면 쿼리를 실행하기에 앞서 쿼리가 유효하게 작성됐는지 검증하는 것이 가능하다. URI 검색과 Request Body 검색에서 모두 사용할 수 있다.

rewrite=true 파라미터를 추가하면 쿼리가 실패했을때 자세한 오류 정보를 제공해준다.

### 4.4.6 Explain API
Explain API를 사용하면 문서 검색 결과의 스코어가 어떻게 계산되는지 자세하게 확인할 수 있다.

이러한 정보를 이용하면 특정 문서가 잘 검색되지 않을 때 디버깅 정보로 유용하게 활용할 수 있다.

### 4.4.7 Profile API 

Profile API는 쿼리에 대한 상세한 수행 계획과 각 수행 계획별로 수행된 시간을 돌려주므로 성능을 튜닝하거나 디버깅할 때 유용하게 활용할 수 있다.

실제 쿼리가 수행된 샤드별로 프로파일 정보를 제공해준다.

# 5 데이터 집계

데이터를 그룹화해서 각종 통계 지표를 제공하기 위해 엘라스틱서치에서는 집계(Aggregation) 기능을 공식적으로 제공한다.

## 5.1 집계

집계(Aggregation)는 데이터를 그룹화하고 통계를 구하는 기능이다.

### 5.1.1 엘라스틱서치와 데이터 분석

엘라스틱서치는 인덱스를 활용해 분산 처리가 가능하기 떄문에 SQL보다 더 많은 데이터를 빠르게 집계할 수 있다.

### 5.1.2 엘라스틱서치가 집계에 사용하는 기술

집계 쿼리로 값을 조회한면 엘라스틱서치의 마스터 노드가 여러 노드에 있는 데이터를 집계해 질의에 답변한다. 

데이터를 분석하는데 있어 집계는 검색보다 더 많은 리소스를 사용한다. 

#### 캐시

엘라스틱서치는 Node query Cache, Share request Cache, Field data Cache 총 3가지의 종류의 캐시를 지원한다.

##### Node query Cache

노드의 모든 샤드가 공유하는 LRU(Least-Recently-Used) 캐시로 filter context에서 사용된 쿼리의 결과만을 캐싱된다.

캐시 용량이 가득차면 사용량이 가장 적은 데이터를 삭제하고 새로운 결과값을 캐싱한다.

```
indices.queries.cache.size: 10%
```
* 필터 캐시의 메모리 크기를 제어하며, 기본값은 10% 이다.

```
index.queries.cache.enabled: true
```
* 쿼리 캐싱 사용 여부를 제어하는 인덱스 별로 구성 가능한 인덱스 설정이다.

#### Share request Cache

Share request Cache는 샤드에서 수행된 쿼리의 결과를 캐싱한다.

샤드의 내용이 변경되면 캐시가 삭제되기 때문에 업데이트가 빈번한 인덱스에서는 오히려 성능 저하를 일으킬 수 있다.

```
indices.requests.cache.size: 1%
```
* 기본 크기는 힙 메모리의 1%를 할당해준다.

#### Field data Cache

엘라스틱서치가 필드에서 집계 연산을 수행할 떄는 모든 필드의 값을 메모리에 로드한다. Field data Cache는 집계가 계산되는 동안 필드의 값을 메모리에 보관한다.


### 5.1.3 실습 데이터 살펴보기

### 5.1.4 Aggregation API 이해하기

* 버킷 집계: 쿼리 결과로 도출된 도큐먼트 집합에 대해 특정 기준으로 나눈 다음 나눠진 도큐먼트들에 대한 산술 연산을 수행한다. 이때 나눠진 도큐먼트들의 모음들이 각 버킷에 해당된다.

* 메트릭 집계: 쿼리 결과로 도출된 도큐먼트 집합에서 필드의 값을 더하거나 평균을 내는 등의 산술 연산을 수행한다.

* 파이프라인 집계: 다른 집계 또는 관련 메트릭 연산의 결과를 집계한다.

* 행렬 집계: 버킷 대상이 되는 도큐먼트의 여러 필드에서 추출한 값으로 행렬 연산을 수행한다. 이를 토대로 다양한 통계 정보를 제공하고 있다.

엘라스틱서치는 집계를 중첩해 사용할 수 있다. 중첩 횟수에 제한은 없으나 중첩할수록 성능 하락이 뒤따른다.

#### 집계 구문의 구조
```json
"aggregations" : { # 'agg'로 줄여서 쓰는 것도 가능하다.
    "<aggregation_name>" : { # 하위 집계의 이름을 기입, 이 이름은 집계의 결과 출력에도 사용된다.
        "<aggregation_type>" : { # 집계의 유형 (term, date_histogram, sum ...)
            <aggregation_body>
        }
        [,"meta" : {  [<meta_data_body>] } ]?
        [,"aggregations" : { [<sub_aggregation>]+ } ]?
        # mete 필드를 사용하거나 aggregations을 중첩(하위 집계)할 수 있다.
    }
    [,"<aggregation_name_2>" : { ... } ]* # 같은 레벨에 또 다른 집계를 정의(중첩 집계)하는 것도 가능하다.(단 부수적인 성격의 집계만 정의할 수 있다.)
}
```
#### 집계 영역

집계를 질의와 함께 수행하면 질의의 결과 영역 안에서 집계가 수행된다. 즉 질의를 통해 반환된 문서들의 집합 내에서 집계를 수행하게 된다.

```json
{
    "query" : {
        "constant_score" : {
            "filter" : {
                "match" : "<필드 조건>"
            }
        }
    },
    "aggs" : {
        "<집계 이름>" : {
            "<집계 타입>" : {
                "field": "<필드명>"
            }
        }
    }
}

```

1. query : 질의를 수행한다. 하위에 필터 조건에 의해 명시한 필드와 값이 일치하는 문서만 반환한다.
2. aggs : 질의를 통해 반환받은 문서들의 집합 내에서 집계를 수행한다.

질의가 생략된다면 내부적으로 match_all 쿼리로 수행되어 전체 문서에 대해 집계가 수행된다.

```json
{
    "size" : 0,
    "aggs" : {
        "<집계 이름>" : {
            "<집계 타입>" : {
                "field": "<필드명>"
            }
        }
    }
}
```
1. size : 질의가 명시돼 있지 않기 때문에 내부적으로는 match_all이 수행되고 size가 0이기 떄문에 결과 집합에 문서들 또한 존재하지 않는다. 즉 문서의 결과는 출력되지 않는다.
2. aggs: 결과 문서가 출력되지 않더라도 실제 검색된 문서의 대상 범위가 전체 문서이기 떄문에 집계는 전체 문서에 대해 수행된다.


글로벌 버킷을 사용하면 질의 내에서도 전체 문서를 대상으로 집계를 수행할 수 있다.
```json
{
    "query" : {
        "constant_score" : {
            "filter" : {
                "match" : "<필드 조건>"
            }
        }
    },
    "aggs" : {
        "<집계 이름>" : {
            "<집계 타입>" : {
                "field": "<필드명>"
            }
        },
        "<집계 이름>" : {
            "global" : {},
            "aggs" : {
                "<집계 이름>" : {
                    "<집계 타입>" : {
                        "field": "<필드명>"
                    }
                }
            }
        }
    }
}

```
1. 일반 버킷 : 질의 영역 내에서만 집계를 수행
2. 글로벌 버킷 : 전체 문서를 대상으로 집계를 수행

## 5.2 메트릭 집계
메트릭 집계는
* 특정 필드에 대해 합이나 평균을 계산
* 다른 집계와 중첩해서 결과에 대해 특정 필드의 _score 값에 따라 정렬
* 지리 정보를 통해 범위 계산

등의 다양한 집계를 수행한다.

* 단일 숫자 메트릭 집계 : 집계를 수행한 결과값이 하나이다.
* 다중 숫자 메트릭 집계 : 집계를 수행한 결과값이 여러 개가 될 수 있다.

### 5.2.1 합산 집계

```json
{
    "aggs" : {
        "total_byte" : {
            "sum" : {
                "field" : "bytes"
            }
        }
    }
}
```

### 5.2.2 평균 집계

```json
{
    "aggs" : {
        "avg_byte" : {
            "avg" : {
                "field" : "bytes"
            }
        }
    }
}
```

### 5.2.3 최소값 집계
```json
{
    "aggs" : {
        "min_byte" : {
            "min" : {
                "field" : "bytes"
            }
        }
    }
}
```

### 5.2.4 최대값 집계

```json
{
    "aggs" : {
        "max_byte" : {
            "max" : {
                "field" : "bytes"
            }
        }
    }
}
```

### 5.2.5 개수 집계

```json
{
    "aggs" : {
        "bytes_count" : {
            "value_count" : {
                "field" : "bytes"
            }
        }
    }
}
```

### 5.2.6 통계 집계

통계 집계는 사용하면 합, 평균 최대값, 최소값, 개수를 한 번의 쿼리로 집계할 수 있다. 

```json
{
    "aggs" : {
        "bytes_stats" : {
            "stats" : {
                "field" : "bytes"
            }
        }
    }
}
```

### 5.2.7 통계 확장 집계

통계 집계를 확장해서 표준편차 같은 다양한 통계값이 추가되었다.

```json
{
    "aggs" : {
        "bytes_extended_stats" : {
            "extened_stats" : {
                "field" : "bytes"
            }
        }
    }
}
```

### 5.2.8 카디널리티 집계

개수 집합과 유사하게 횟수를 계산하는데 중복된 값을 제외한 고유한 값에 대한 집계를 수행한다.

모든 문서에 대해 중복된 값을 계산하는 것은 성능에 큰 영향을 줄 수 있기 때문에 근사치를 통해 집계를 수행한다.

```json
{
    "aggs" : {
        "type_count" : {
            "cardinality" : {
                "field" : "type"
            }
        }
    }
}
```

### 5.2.9 백분위 수 집계

백분위 수 집계 또한 카디널리티 집계와 같이 근사치 계산으로 집계된다.

```json
{
    "aggs" : {
        "load_time_outlier" : {
            "percentiles" : {
                "field" : "load_time" 
            }
        }
    }
}

>>>

{
    ...

   "aggregations": {
      "load_time_outlier": {
         "values" : {
            "1.0": 5.0,
            "5.0": 25.0,
            "25.0": 165.0,
            "50.0": 445.0,
            "75.0": 725.0,
            "95.0": 945.0,
            "99.0": 985.0
         }
      }
   }
}
```

### 5.2.10 백분위 수 랭크 집계

특정 필드의 수치를 통해 백분위의 어느 구간에 속하는지 확인할 수 있다.

```json
{
    "aggs" : {
        "load_time_ranks" : {
            "percentile_ranks" : {
                "field" : "load_time", 
                "values" : [500, 600]
            }
        }
    }
}

>>>

{
    ...

   "aggregations": {
      "load_time_ranks": {
         "values" : {
            "500.0": 90.01,
            "600.0": 100.0
         }
      }
   }
}
```

### 5.2.11 지형 경계 집계

지형 경계 집계는 필드의 지형 좌표 값을 포함하는 경계 상자를 계산하는 메트릭 집계이다. 이 집계를 사용하렴녀 계산하려는 필드의 타입이 geo_point여야 한다.

### 5.2.12 지형 중심 집계

지형 중심 집계는 앞서 살펴본 지형 경계 집계의 범위에서 정가운데의 위치를 반환한다.

